---
version: '3'

services:
  elas01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
    container_name: elas01
    env_file: docker/elasticsearch.env
    environment:
      - node.name=elas01
      - discovery.seed_hosts=elas02,elas03
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile: 65535
      nproc: 4096
    volumes:
      - ./docker/build-certs/pki/intermediate/certs/elas01.cert.pem:/usr/share/elasticsearch/config/pki/elas.cert.pem
      - ./docker/build-certs/pki/intermediate/private/elas01.key.pem:/usr/share/elasticsearch/config/pki/elas.key.pem
      - ./docker/build-certs/pki/intermediate/certs/ca-chain.cert.pem:/usr/share/elasticsearch/config/pki/ca.cert.pem
      - ./docker/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./docker/elastic-healthcheck.sh:/bin/elastic-healthcheck.sh
      - data01:/usr/share/elasticsearch/data
    networks:
      - elastic
    healthcheck:
      test: /bin/elastic-healthcheck.sh
      interval: 30s
      timeout: 10s
      retries: 5
    ports:
      - 9200:9200
  elas02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
    container_name: elas02
    env_file: docker/elasticsearch.env
    environment:
      - node.name=elas02
      - discovery.seed_hosts=elas01,elas03
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile: 65535
      nproc: 4096
    volumes:
      - ./docker/build-certs/pki/intermediate/certs/elas02.cert.pem:/usr/share/elasticsearch/config/pki/elas.cert.pem
      - ./docker/build-certs/pki/intermediate/private/elas02.key.pem:/usr/share/elasticsearch/config/pki/elas.key.pem
      - ./docker/build-certs/pki/intermediate/certs/ca-chain.cert.pem:/usr/share/elasticsearch/config/pki/ca.cert.pem
      - ./docker/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./docker/elastic-healthcheck.sh:/bin/elastic-healthcheck.sh
      - data02:/usr/share/elasticsearch/data
    networks:
      - elastic
    healthcheck:
      test: /bin/elastic-healthcheck.sh
      interval: 30s
      timeout: 10s
      retries: 5
  elas03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
    container_name: elas03
    env_file: docker/elasticsearch.env
    environment:
      - node.name=elas03
      - discovery.seed_hosts=elas02,elas03
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile: 65535
      nproc: 4096
    volumes:
      - ./docker/build-certs/pki/intermediate/certs/elas03.cert.pem:/usr/share/elasticsearch/config/pki/elas.cert.pem
      - ./docker/build-certs/pki/intermediate/private/elas03.key.pem:/usr/share/elasticsearch/config/pki/elas.key.pem
      - ./docker/build-certs/pki/intermediate/certs/ca-chain.cert.pem:/usr/share/elasticsearch/config/pki/ca.cert.pem
      - ./docker/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./docker/elastic-healthcheck.sh:/bin/elastic-healthcheck.sh
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    healthcheck:
      test: /bin/elastic-healthcheck.sh
      interval: 30s
      timeout: 10s
      retries: 5
  logs01:
    image: docker.elastic.co/logstash/logstash:7.5.1
    container_name: logs01
    ports:
      - 9600:9600
    environment:
      - PATH_DATA=/usr/share/logstash/data
      - ELASTICSEARCH_PASSWORD=${LOGSTASH_USER_PASSWORD}
      - XPACK_MONITORING_ELASTICSEARCH_HOSTS=https://elas01:9200,https://elas02:9200,https://elas03:9200
      - XPACK_MONITORING_ELASTICSEARCH_PASSWORD=${LOGSTASH_SYSTEM_PASSWORD}
      - XPACK_MONITORING_ELASTICSEARCH_SSL_CERTIFICATE_AUTHORITY=/usr/share/logstash/config/pki/ca.cert.pem
    volumes:
      - ./docker/build-certs/pki/intermediate/certs/logs01.cert.pem:/usr/share/logstash/config/pki/logs.cert.pem
      - ./docker/build-certs/pki/intermediate/private/logs01.key.pem:/usr/share/logstash/config/pki/logs.key.pem
      - ./docker/build-certs/pki/intermediate/certs/ca-chain.cert.pem:/usr/share/logstash/config/pki/ca.cert.pem
      - ./docker/dynamicbeat-pipeline.conf:/usr/share/logstash/pipeline/dynamicbeat-pipeline.conf
      - data04:/usr/share/logstash/data
    networks:
      - elastic
  kiba01:
    image: docker.elastic.co/kibana/kibana:7.5.1
    container_name: kiba01
    ports:
      - 5601:5601
    environment:
      - ELASTICSEARCH_PASSWORD=${KIBANA_PASSWORD}
    volumes:
      - ./docker/build-certs/pki/intermediate/certs/localhost.cert.pem:/usr/share/kibana/config/pki/kiba.cert.pem
      - ./docker/build-certs/pki/intermediate/private/localhost.key.pem:/usr/share/kibana/config/pki/kiba.key.pem
      - ./docker/build-certs/pki/intermediate/certs/ca-chain.cert.pem:/usr/share/kibana/config/pki/ca.cert.pem
      - ./docker/kibana.yml:/usr/share/kibana/config/kibana.yml
      - data05:/usr/share/kibana/data
    networks:
      - elastic

volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local
  data04:
    driver: local
  data05:
    driver: local

networks:
  elastic:
    driver: bridge